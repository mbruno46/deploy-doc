name: 'deploy-sphinx-doc'
description: 'Deploy Python documentation generated with Sphinx'
inputs:
  repository:
    description: 'Repository name with owner, e.g. mbruno46/chiexp'
    default: ${{ github.repository }}
  ref:
    description: >
      The branch, tag or SHA to checkout. When checking out the repository that
      triggered a workflow, this defaults to the reference or SHA for that
      event.  Otherwise, uses the default branch.
  path: 
    description: 'Relative path in the repository with documentation source files'
    required: true
  doc-branch:
    description: 'Target branch for documentation deployment'
    required: true
    default: 'gh-pages'
  pdf:
    description: 'Name of latex file generated by Sphinx, without .tex extension'
    default: ''
runs:
  using: "composite"
  steps:
    - name: 'Print github context'
      run: echo $GITHUB_CONTEXT
      shell: bash
    - name: 'Install Sphinx'
      run: |
        pip install sphinx
      shell: bash
    - name: 'Build/Deploy Doc'
      run: |
        cd ${GITHUB_REPOSITORY#*/}/${{ inputs.path }}
        make html
        cd build/html
        git init
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git config --global user.name "${{ github.actor }}"
        git add .
        git commit -m '[deploy-sphinx-doc] publishing documentation'
        git remote add origin https://${{ github.actor }}:${{ github.token }}@github.com/${{ inputs.repository }}.git
        git config --global --list
        git push --force origin master:${{ inputs.doc-branch }}
        cd ../../
        if [ "${{ inputs.pdf }}" == "" ]; then
           make latexpdf
           cp -p build/latex/${{ inputs.pdf }}.pdf .
           git add ${{ inputs.pdf }}.pdf
           git commit -m '[deploy-sphinx-doc] pdf documentation file updated'
           git push https://${{ github.actor }}:${{ github.token }}@github.com/${{ inputs.repository }}.git ${{ inputs.ref }}
        fi
      shell: bash
